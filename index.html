
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Study Quiz App â€“ Fully Responsive</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    html { box-sizing: border-box; -webkit-text-size-adjust: 100%; }
    *, *::before, *::after { box-sizing: inherit; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      background-color: #fff;
      color: #000;
      margin: 0;
      padding: 1rem;
      font-size: 18px;
      line-height: 1.6;
    }

    .container { max-width: 600px; margin: 0 auto; }

    h2 { font-size: 1.6rem; margin-bottom: 1rem; }

    button {
      background-color: #007AFF;
      color: #fff;
      border: none;
      border-radius: 12px;
      padding: 14px 22px;
      font-size: 1rem;
      margin-top: 1rem;
      margin-right: 0.5rem;
      min-width: 44px;
      min-height: 44px;
    }

    button:hover { background-color: #005BBB; }

    input[type="radio"], input[type="checkbox"] {
      accent-color: #007AFF;
      width: 1.4rem;
      height: 1.4rem;
    }

    .question { font-size: 1.3rem; font-weight: 600; margin-bottom: 1rem; }
    .options { margin-bottom: 1.5rem; }
    .options div { margin-bottom: 0.75rem; }

    .feedback { font-size: 1rem; font-weight: 500; margin-top: 1rem; }
    label { font-size: 1rem; margin-left: 0.5rem; }

    table {
      width: 100%; border-collapse: collapse;
      margin-top: 2rem; font-size: 0.95rem;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 0.75rem;
      text-align: left;
    }

    th { background: #f2f2f2; }

    #error { color: red; margin-top: 1rem; }

    @media (max-width: 480px) {
      body { padding: 1rem; font-size: 18px; }
      h2 { font-size: 1.4rem; }
      .question { font-size: 1.2rem; }
      button { font-size: 1rem; padding: 12px 20px; }
      label { font-size: 1rem; }
      table { font-size: 0.85rem; }
    }
  </style>
</head>
<body>
<div class="container">
  <h2>Study Quiz App (Fully Responsive)</h2>
  <input type="file" id="upload" accept=".xlsx" />
  <div id="subject-picker" style="margin-top: 20px;"></div>
  <div id="quiz"></div>
  <div id="buttons"></div>
  <div id="feedback"></div>
  <div id="error"></div>
</div>

<script>
let allQuestions = [], selectedQuestions = [], currentQuestionIndex = 0;
let userAnswers = {}, quizHistory = [];

document.getElementById('upload').addEventListener('change', function(e) {
  const reader = new FileReader();
  reader.onload = function(event) {
    const data = new Uint8Array(event.target.result);
    const workbook = XLSX.read(data, { type: 'array' });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(sheet, { defval: "" });

    allQuestions = json.map(q => {
      if (!q.Exam || !q.Question || !q.Answer || !q.Correct) return null;
      return {
        exam: q.Exam.trim(),
        question: q.Question.trim(),
        options: q.Answer.split(/\r?\n/).map(opt => opt.trim()).filter(opt => opt),
        correct: q.Correct.trim().toUpperCase().split(',').map(ans => ans.trim())
      };
    }).filter(q => q !== null);

    showSubjectPicker();
  };
  reader.readAsArrayBuffer(e.target.files[0]);
});

function showSubjectPicker() {
  const container = document.getElementById('subject-picker');
  document.getElementById('quiz').innerHTML = "";
  document.getElementById('feedback').innerHTML = "";
  const subjects = [...new Set(allQuestions.map(q => q.exam))].sort();
  container.innerHTML = `
    <label for="subject">Choose a subject:</label>
    <select id="subject">
      ${subjects.map(s => `<option value="${s}">${s}</option>`).join('')}
    </select>
    <button onclick="startQuiz()">Start Quiz</button>
  `;
}

function startQuiz() {
  const subject = document.getElementById('subject').value;
  selectedQuestions = allQuestions.filter(q => q.exam === subject);
  currentQuestionIndex = 0;
  userAnswers = {};
  quizHistory = [];
  showQuestion();
}

function isMultipleChoice(txt) {
  return /(choose|select|pick)/i.test(txt);
}

function extractAnswerLetter(opt) {
  return typeof opt === 'string' ? opt.split('.')[0].trim().toUpperCase() : '';
}

function showQuestion() {
  const q = selectedQuestions[currentQuestionIndex];
  const multiple = isMultipleChoice(q.question);
  const saved = userAnswers[currentQuestionIndex] || [];

  document.getElementById('quiz').innerHTML = `
    <div class="question">Q${currentQuestionIndex + 1} of ${selectedQuestions.length}: ${q.question}</div>
    <div class="options">
      ${q.options.map((opt, idx) => {
        const val = extractAnswerLetter(opt);
        const checked = saved.includes(val) ? "checked" : "";
        return `
          <div>
            <input type="${multiple ? 'checkbox' : 'radio'}"
                   name="optgroup${currentQuestionIndex}"
                   id="opt${idx}" value="${val}" ${checked}
                   onchange="saveSelection(${multiple})">
            <label for="opt${idx}">${opt}</label>
          </div>`;
      }).join('')}
    </div>
  `;

  document.getElementById('buttons').innerHTML = `
    <button onclick="prevQuestion()" ${currentQuestionIndex === 0 ? "disabled" : ""}>Previous</button>
    <button onclick="nextQuestion()">Next</button>
  `;
  document.getElementById('feedback').innerHTML = "";
}

function saveSelection(multiple) {
  const inputs = document.querySelectorAll('input[name="optgroup' + currentQuestionIndex + '"]:checked');
  userAnswers[currentQuestionIndex] = Array.from(inputs).map(i => i.value.trim().toUpperCase());
}

function prevQuestion() {
  saveSelection(isMultipleChoice(selectedQuestions[currentQuestionIndex].question));
  if (currentQuestionIndex > 0) currentQuestionIndex--;
  showQuestion();
}

function nextQuestion() {
  saveSelection(isMultipleChoice(selectedQuestions[currentQuestionIndex].question));
  const selected = userAnswers[currentQuestionIndex] || [];
  const correct = selectedQuestions[currentQuestionIndex].correct.map(a => a.toUpperCase().trim());
  const match = selected.slice().sort().join() === correct.slice().sort().join();

  document.getElementById('feedback').innerHTML = match
    ? '<span style="color:green;">Correct!</span>'
    : '<span style="color:red;">Wrong! Correct answer(s): ' + correct.join(', ') + '</span>';

  setTimeout(() => {
    if (currentQuestionIndex < selectedQuestions.length - 1) {
      currentQuestionIndex++;
      showQuestion();
    } else {
      finishQuiz();
    }
  }, 1500);
}

function finishQuiz() {
  quizHistory = selectedQuestions.map((q, idx) => {
    const selected = userAnswers[idx] || [];
    const correct = q.correct.map(ans => ans.trim().toUpperCase());
    const correctSorted = correct.slice().sort();
    const selectedSorted = selected.slice().sort();
    const result = (correctSorted.length === selectedSorted.length &&
                    correctSorted.every((v, i) => v === selectedSorted[i])) ? "Correct" : "Wrong";
    return { question: q.question, selected, correctAnswers: correct, result };
  });
  showReview();
}

function showReview() {
  document.getElementById('buttons').innerHTML = "";
  document.getElementById('quiz').innerHTML = `
    <h3>Quiz Complete!</h3>
    <p>Score: ${quizHistory.filter(q => q.result === "Correct").length}/${quizHistory.length}</p>
    <table>
      <tr><th>#</th><th>Question</th><th>Your Answer</th><th>Correct</th><th>Result</th></tr>
      ${quizHistory.map((q, i) => `
        <tr>
          <td>${i + 1}</td>
          <td>${q.question}</td>
          <td>${q.selected.join(', ')}</td>
          <td>${q.correctAnswers.join(', ')}</td>
          <td style="color:${q.result === 'Correct' ? 'green' : 'red'};">${q.result}</td>
        </tr>`).join('')}
    </table>
    <button onclick="showSubjectPicker()">Choose another subject</button>
  `;
  document.getElementById('feedback').innerHTML = "";
}
</script>
</body>
</html>
